# Common build rules, used by the sub modules and their module.mk files

MODULE_OBJS-$(MODULE) := $(MODULE_OBJS)
MODULE_LIB-$(MODULE) := $(MODULE)/lib$(MODULE).a

ifdef PLUGIN
# Plugin build rule
# TODO: Right now, for Mac OS X only. We either will have to generate this
# via the configure script, or put in some 'if' statements to choose from
# one of several build rules
PLUGIN-$(MODULE) := $(MODULE)/$(PLUGIN_PREFIX)$(MODULE)$(PLUGIN_SUFFIX)
$(PLUGIN-$(MODULE)): $(MODULE_OBJS) $(EXECUTABLE)
	$(CXX) $(PLUGIN_LDFLAGS) $(filter-out $(EXECUTABLE),$+) $(LIBS) -o $@
PLUGIN:=
plugins: $(PLUGIN-$(MODULE))

else

# If not building as a plugin, add the object files to the main OBJS list
OBJS += $(MODULE_LIB-$(MODULE))
endif


# Clean target, removes all object files. This looks a bit hackish, as we have to
# copy the content of MODULE_OBJS to another unique variable (the next module.mk
# will overwrite it after all). The same for the libMODULE.a library file.
clean: clean-$(MODULE)
clean-$(MODULE): clean-% :
	-$(RM) $(MODULE_OBJS-$*) $(MODULE_LIB-$*) $(PLUGIN-$*)

# Convenience library target
$(MODULE_LIB-$(MODULE)): $(MODULE_OBJS)
	-$(RM) $@
	$(AR) $@ $+
	$(RANLIB) $@ 


# Pseudo target for comfort, allows for "make common", "make gui" etc.
$(MODULE): $(MODULE_LIB-$(MODULE))

.PHONY: clean-$(MODULE) $(MODULE)
